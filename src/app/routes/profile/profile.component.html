<section class="profile-page">
  @if (user()) {
    <app-user-info-card
      [name]="user()!.name"
      [email]="user()!.email"
      [avatarUrl]="avatarUrl()"
      [role]="user()!.role"
      [joinedDate]="user()!.createdAt"
    />

    @if (successMessage()) {
      <div class="message success-message">{{ successMessage() }}</div>
    }
    @if (errorMessage()) {
      <div class="message error-message">{{ errorMessage() }}</div>
    }

    @if (!isEditing()) {
      <section class="profile-actions">
        <app-button (click)="startEditing()">Edit Profile</app-button>
        <app-button variant="secondary" (click)="togglePasswordForm()">Change Password</app-button>
      </section>
    } @else {
      <section class="edit-profile-form">
        <h3>Edit Profile</h3>
        <form [formGroup]="editForm" (ngSubmit)="saveProfile()">
          <div class="form-group">
            <label for="name">Name</label>
            <input
              id="name"
              type="text"
              formControlName="name"
              class="form-input"
              [class.error]="editForm.get('name')?.touched && editForm.get('name')?.errors"
            />
            @if (editForm.get('name')?.touched && editForm.get('name')?.errors) {
              <div class="form-error">
                @if (editForm.get('name')?.errors?.['required']) {
                  Name is required
                }
                @if (editForm.get('name')?.errors?.['minlength']) {
                  Name must be at least 2 characters
                }
              </div>
            }
          </div>

          <div class="form-group">
            <label for="email">Email</label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="form-input"
              [class.error]="editForm.get('email')?.touched && editForm.get('email')?.errors"
            />
            @if (editForm.get('email')?.touched && editForm.get('email')?.errors) {
              <div class="form-error">
                @if (editForm.get('email')?.errors?.['required']) {
                  Email is required
                }
                @if (editForm.get('email')?.errors?.['email']) {
                  Please enter a valid email address
                }
              </div>
            }
          </div>

          <div class="form-actions">
            <app-button 
              type="submit" 
              [disabled]="isLoading() || editForm.invalid"
            >
              @if (isLoading()) {
                Saving...
              } @else {
                Save Changes
              }
            </app-button>
            <app-button 
              variant="secondary" 
              type="button" 
              (click)="cancelEditing()"
              [disabled]="isLoading()"
            >
              Cancel
            </app-button>
          </div>
        </form>
      </section>
    }

    @if (showPasswordForm()) {
      <section class="password-form">
        <h3>Change Password</h3>
        <form [formGroup]="passwordForm" (ngSubmit)="updatePassword()">
          <div class="form-group">
            <label for="password">New Password</label>
            <input
              id="password"
              type="password"
              formControlName="password"
              class="form-input"
              [class.error]="passwordForm.get('password')?.touched && passwordForm.get('password')?.errors"
            />
            @if (passwordForm.get('password')?.touched && passwordForm.get('password')?.errors) {
              <div class="form-error">
                @if (passwordForm.get('password')?.errors?.['required']) {
                  Password is required
                }
                @if (passwordForm.get('password')?.errors?.['minlength']) {
                  Password must be at least 6 characters
                }
              </div>
            }
          </div>

          <div class="form-actions">
            <app-button 
              type="submit" 
              [disabled]="isLoading() || passwordForm.invalid"
            >
              @if (isLoading()) {
                Updating...
              } @else {
                Update Password
              }
            </app-button>
            <app-button 
              variant="secondary" 
              type="button" 
              (click)="togglePasswordForm()"
              [disabled]="isLoading()"
            >
              Cancel
            </app-button>
          </div>
        </form>
      </section>
    }
  }
  @else {
    <div class="profile-loading">Loading profile...</div>
  }
</section>
